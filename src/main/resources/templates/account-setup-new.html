<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/general.html :: head"></head>
<body>
<header th:replace="fragments/general.html::header"></header>

<div class="bootstrap-wrapper">
    <div class="container">

        <div class="page-info row">
            <div class="col-md-12">
                <span class="name">Account</span>

            </div>
        </div>

        <form th:action="${'/employee-portal/sales/account/new/save'}" th:object="${account}" method="post">

            <input type="text" th:field="*{id}" th:value="*{id}" hidden>

            <input th:if="${#bools.isTrue(createUpdated)} or ${#bools.isTrue(approveUpdated)}"
                   th:field="*{baseVersion}" th:value="*{baseVersion}" hidden>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Name</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" th:field="*{name}">
                        <p th:each="error : ${#fields.errors('name')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Address 1</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" th:field="*{addressFirst}">
                        <p th:each="error : ${#fields.errors('addressFirst')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Address 2</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" th:field="*{addressSecond}">
                        <p th:each="error : ${#fields.errors('addressSecond')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">City</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" th:field="*{city}">
                        <p th:each="error : ${#fields.errors('city')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">State</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" th:field="*{state}">
                        <p th:each="error : ${#fields.errors('state')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">ZIP</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" placeholder="00000{-0000}" th:field="*{ZIP}">
                        <p th:each="error : ${#fields.errors('ZIP')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Phone</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" placeholder="000-000-0000" th:field="*{phone}">
                        <p th:each="error : ${#fields.errors('phone')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Fax</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" placeholder="000-000-0000" th:field="*{fax}">
                        <p th:each="error : ${#fields.errors('fax')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Direct Line</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" placeholder="000-000-0000" th:field="*{directLine}">
                        <p th:each="error : ${#fields.errors('directLine')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Contact First Name</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" th:field="*{contactFirstName}">
                        <p th:each="error : ${#fields.errors('contactFirstName')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Contact Last Name</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="text" th:field="*{contactLastName}">
                        <p th:each="error : ${#fields.errors('contactLastName')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>


            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Contact Email</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <input class="form-in-item" type="email" th:field="*{contactEmail}">
                        <p th:each="error : ${#fields.errors('contactEmail')}" th:text="${error}">Validation error</p>
                    </div>
                </div>
            </div>

            <div class="providers-section">
                <hr>
                <h3>Providers</h3>
                <div class="profile-edit-item row">

                    <div class="col-md-4">
<!--                        <input type="text" th:field="*{providers}" hidden>-->
                        <button type="button" class="add-provider-btn">Add Provider</button>
                    </div>
                    <div class="col-md-8">
                        <div class="input-wrapper">
                            <table>
                                <tbody class="providers-table">
                                <tr class="provider-row" th:each="provider, rowStat : *{providers}">
<!--                                    <input type="text" th:field="*{providers[__${rowStat.index}__].id}" th:value="*{providers[__${rowStat.index}__].id}" hidden>-->
                                    <td>
                                        <select class="form-in-item" th:field="*{providers[__${rowStat.index}__].title}">
                                            <option th:each="tit : ${titles}"
                                                    th:value="${tit.id}"
                                                    th:text="${tit.name}">
                                            </option>
                                        </select>
                                    </td>
                                    <td>
                                        <span>First Name</span>
                                        <input type="text" th:field="*{providers[__${rowStat.index}__].firstName}"/>
                                        <!--                                    <p th:each="error : ${#fields.errors('providers[' + rowStat.index + '].firstname')}" th:text="${error}">Validation error</p>-->
                                    </td>
                                    <td>
                                        <span>Last Name</span>
                                        <input type="text" th:field="*{providers[__${rowStat.index}__].lastName}"/>
                                        <!--                                    <p th:each="error : ${#fields.errors('providers[' + __${rowStat.index}__ + '].lastName')}" th:text="${error}">Validation error</p>-->
                                    </td>

                                    <td>
                                        <span>Email</span>
                                        <input type="email" th:field="*{providers[__${rowStat.index}__].email}"/>
                                        <!--                                    <p th:each="error : ${#fields.errors('providers[' + *{__${rowStat.index}__ } + '].email')}" th:text="${error}">Validation error</p>-->
                                    </td>
                                    <td>
                                        <span>NPI</span>
                                        <input type="text" th:field="*{providers[__${rowStat.index}__].NPI}" placeholder="0000000000"/>
                                        <!--                                    <p th:each="error : ${#fields.errors('providers['+*{__${rowStat.index}__ }+'].NPI')}" th:text="${error}">Validation error</p>-->
                                    </td>
                                    <td>
                                        <button type="button" class="remove-provider-btn">Remove</button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="specimen-pick-ups-section">
                <hr>
                <h3>Specimen pick ups</h3>
                <div>
                    <div th:each="spudt, spudtStat : *{specimenPickUpDayTimes}" class="profile-edit-item row specimen-pick-ups-item">
                        <div class="col-md-4">
                            <hr>
                            <p class="name  specimen-pick-up-day" th:text="${spudt.pickUpDayOfWeek.name}"></p>

                            <input type="text"
                                   th:field="*{specimenPickUpDayTimes[__${spudtStat.index}__].id}"
                                   th:value="*{specimenPickUpDayTimes[__${spudtStat.index}__].id}" hidden>

                            <input type="text"
                                   th:field="*{specimenPickUpDayTimes[__${spudtStat.index}__].pickUpDayOfWeek}"
                                   th:value="*{specimenPickUpDayTimes[__${spudtStat.index}__].pickUpDayOfWeek}" hidden>

<!--                            <input type="text"-->
<!--                                   th:field="*{specimenPickUpDayTimes[__${spudtStat.index}__].pickUpTimes}"-->
<!--                                   th:value="*{specimenPickUpDayTimes[__${spudtStat.index}__].pickUpTimes}" hidden>-->

                            <button type="button" class="add-pick-up-time-btn">App Pick Time</button>

                        </div>
                        <div class="col-md-8">
                            <div class="specimen-pick-up-times">

                                <div th:each="put, putStat : *{specimenPickUpDayTimes[__${spudtStat.index}__].pickUpTimes}" class="specimen-pick-up-times-item">

<!--                                    <input type="text"-->
<!--                                           th:field="*{specimenPickUpDayTimes[__${spudtStat.index}__].pickUpTimes[__${putStat.index}__].id}"-->
<!--                                           th:value="*{specimenPickUpDayTimes[__${spudtStat.index}__].pickUpTimes[__${putStat.index}__].id}" hidden>-->

                                    <input class="form-in-item" type="time"
                                           th:field="*{specimenPickUpDayTimes[__${spudtStat.index}__].pickUpTimes[__${putStat.index}__].pickUpTime}">

                                    <button type="button" class="remove-pick-up-time-btn">Remove</button>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Provider Portal</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <select class="form-in-item" th:field="*{providerPortal}">
                            <option th:value="1" >Yes</option>
                            <option th:value="0" >No</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="profile-edit-item row">
                <div class="col-md-4">
                    <p class="name">Paper Requisitions</p>
                </div>
                <div class="col-md-8">
                    <div class="input-wrapper">
                        <select class="form-in-item" th:field="*{paperRequisitions}">
                            <option th:value="1" >Yes</option>
                            <option th:value="0" >No</option>
                        </select>
                    </div>
                </div>
            </div>

            <button th:if="${#bools.isTrue(createUnregistered)}"
                   th:formaction="@{'/employee-portal/sales/account/new/save'}" class="btn form-submit-btn"
                    type="submit">Propose new account</button>

            <button th:if="${#bools.isTrue(createUpdated)}"
                   th:formaction="@{'/employee-portal/sales/account/update/save'}" class="btn form-submit-btn"
                   type="submit">Propose account updating</button>

            <button th:if="${#bools.isTrue(approveUnregistered)}"
                    th:formaction="@{'/employee-portal/admin/account/approve-unregistered/save'}" class="btn form-submit-btn"
                    type="submit">Approve</button>

            <button th:if="${#bools.isTrue(approveUpdated)}"
                    th:formaction="@{'/employee-portal/admin/account/approve-updated/save'}" class="btn form-submit-btn"
                    type="submit">Approve</button>

            <button th:if="${#bools.isTrue(updateCreate)}"
                    th:formaction="@{'/employee-portal/admin/account/update-create/save'}" class="btn form-submit-btn"
                    type="submit">Approve</button>
        </form>
    </div>
</div>

<footer th:replace="fragments/general.html :: footer"></footer>

<script th:inline="javascript">

    document.addEventListener("DOMContentLoaded", function(){

        /*<![CDATA[*/

        const TITLES = /*[[${titles}]]*/ [ 'MR', 'MS' ];
        const MAX_PROVIDERS = /*[[${maxProviders}]]*/ 5;
        const MAX_PICK_UP_TIMES = /*[[${maxPickUpTimes}]]*/ 2;

        /*]]>*/


        let addProviderBtn = document.querySelector(".add-provider-btn");

        addProviderBtn.addEventListener("click", ()=>{

            let providersTableNode = document.querySelector(".providers-table");
            let provsCount = providersTableNode.children.length;

            if( provsCount < MAX_PROVIDERS){

                let options = '';
                for(title of TITLES){
                    options+=`<option value="${title['id']}">${title['name']}</option>`;
                }

                providersTableNode.insertAdjacentHTML('beforeend',
                    `<tr class="provider-row">
                            <td>
                                <select class="form-in-item" id="providers${provsCount}.title" name="providers[${provsCount}].title">
                                 ${options}
                                </select>
                            </td>
                            <td>
                                <span>First Name</span>
                                <input type="text" id="providers${provsCount}.firstName" name="providers[${provsCount}].firstName"/>
                            </td>
                            <td>
                                <span>Last Name</span>
                                <input type="text" id="providers${provsCount}.lastName" name="providers[${provsCount}].lastName"/>
                            </td>

                            <td>
                                <span>Email</span>
                                <input type="email" id="providers${provsCount}.email" name="providers[${provsCount}].email"/>
                            </td>
                            <td>
                                <span>NPI</span>
                                <input type="text" placeholder="0000000000" id="providers${provsCount}.NPI" name="providers[${provsCount}].NPI"/>
                            </td>
                            <td>
                                <button type="button" class="remove-provider-btn">Remove</button>
                            </td>
                        </tr>`);
            }
        });


        window.addEventListener("click", (evt) => {

            let elementClicked = evt.target;


            if(elementClicked.classList.contains("add-pick-up-time-btn")){

                let specimenPickUpDayTimes = elementClicked.closest(".specimen-pick-ups-item")
                let nodes = Array.prototype.slice.call(specimenPickUpDayTimes.parentElement.querySelectorAll(".specimen-pick-ups-item"));
                let dayIndex = nodes.indexOf(specimenPickUpDayTimes);

                let specimenPickUpTimes = specimenPickUpDayTimes.querySelector(".specimen-pick-up-times");

                let specimenPickUpTimesAmount = specimenPickUpTimes.children.length;

                if(specimenPickUpTimesAmount < MAX_PICK_UP_TIMES){
                    specimenPickUpTimes.insertAdjacentHTML("beforeend",
                        `<div class="specimen-pick-up-times-item">

                            <input class="form-in-item" type="time"
                                id="specimenPickUpDayTimes${dayIndex}.pickUpTimes${specimenPickUpTimesAmount}.pickUpTime"
                                name="specimenPickUpDayTimes[${dayIndex}].pickUpTimes[${specimenPickUpTimesAmount}].pickUpTime">

                            <button type="button" class="remove-pick-up-time-btn">Remove</button>

                        </div>`)
                }

            }
            else if(elementClicked.classList.contains("remove-provider-btn")) {



                let elementToDelete = elementClicked.closest('.provider-row');
                elementToDelete.parentElement.removeChild(elementToDelete);

                let parentElementToUpdateChildrenIds = document.querySelector(".providers-table");
                updateElementInnerAttributesIndexes(parentElementToUpdateChildrenIds,
                    "providers",
                    'input, select');


            }else if(elementClicked.classList.contains("remove-pick-up-time-btn")){


                let elementToDelete = elementClicked.closest('.specimen-pick-up-times-item');
                let elementToUpdateChildrenIds = evt.target.closest(".specimen-pick-up-times");
                elementToDelete.parentElement.removeChild(elementToDelete);

                updateElementInnerAttributesIndexes(elementToUpdateChildrenIds,
                    "pickUpTimes",
                    'input');

            }
        });

        function updateElementInnerAttributesIndexes(parentElem,
                                                     indexOf,
                                                     childInnerElemsSelector,
                                                     attributesToUpdate = ["id", "name"],
                                                     startIndex = 0){

            for(let providersChildNode of parentElem.children){
                let elementsToUpdate = providersChildNode.querySelectorAll(childInnerElemsSelector);
                for(let elementToUpdate of elementsToUpdate){
                    updateElementAttrsIndex(elementToUpdate, attributesToUpdate, startIndex, indexOf);
                }
                ++startIndex;
            }
        }

        function updateElementAttrsIndex(element, attributes, index, indexOf){
            for(let attrName of attributes){
                if(element.hasAttribute(attrName)){
                    let attributeVal  = element.getAttribute(attrName);

                    let regexp = new RegExp(`(${indexOf}.?)(\\d+)`, "g")

                    attributeVal = attributeVal.replace(regexp, "$1" + index);
                    element.setAttribute(attrName, attributeVal);
                }
            }
        }



    });

</script>
</body>
</html>